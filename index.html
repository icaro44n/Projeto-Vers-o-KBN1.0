<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban de Manutenção & Reparos</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Sortable.js (Drag and Drop) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <!-- DOMPurify (Segurança) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <!-- Fonte -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Fonte Inter para melhor leitura */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f0fdf4; /* Fundo levemente esverdeado */
        }

        /* Estilos do Sortable.js (Drag & Drop) */
        .sortable-ghost { 
            opacity: 0.4; 
            background: #dcfce7; 
            border: 2px dashed #22c55e; 
        }

        .sortable-chosen { 
            cursor: grabbing; 
            opacity: 1; 
            transform: scale(1.02); 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            z-index: 50;
        }

        /* Scroll suave dentro das colunas */
        .kanban-column-body { 
            max-height: 72vh; 
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #bbf7d0 transparent;
            min-height: 200px; /* Garante área de drop mesmo vazia */
            padding-bottom: 20px;
        }

        .kanban-column-body::-webkit-scrollbar {
            width: 6px;
        }
        .kanban-column-body::-webkit-scrollbar-track {
            background: transparent;
        }
        .kanban-column-body::-webkit-scrollbar-thumb {
            background-color: #bbf7d0;
            border-radius: 20px;
        }

        /* Animação de Modal */
        .modal-transition {
            transition: opacity 0.2s ease-out;
        }
        .modal-content-transition {
            transition: all 0.2s ease-out;
        }
        
        /* Badge de Tipo de Serviço */
        .badge-service {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 700;
        }
    </style>
</head>
<body class="antialiased text-gray-900 bg-gray-50">

    <!-- PÁGINA DE LOGIN -->
    <div id="login-page" class="flex items-center justify-center min-h-screen bg-gradient-to-br from-green-100 to-green-200">
        <div class="bg-white p-8 md:p-10 rounded-xl shadow-2xl max-w-md w-full border border-green-100 relative">
            <div class="flex justify-center mb-6">
                <div class="bg-green-700 p-3 rounded-lg shadow-lg">
                    <!-- Ícone de Ferramenta/Manutenção em Branco -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                </div>
            </div>
            <h2 id="form-title" class="text-2xl font-bold text-center text-gray-800 mb-2">PCM PEÇAS</h2>
            <p class="text-center text-gray-500 text-sm mb-8">Gestão de Reparos </p>

            <form id="auth-form" class="space-y-5">
                <div>
                    <label for="email" class="block text-xs font-bold text-gray-500 uppercase mb-1">Email Corporativo</label>
                    <input type="email" id="email" name="email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none transition-all bg-gray-50">
                </div>
                <div>
                    <label for="password" class="block text-xs font-bold text-gray-500 uppercase mb-1">Senha</label>
                    <input type="password" id="password" name="password" required minlength="6" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none transition-all bg-gray-50">
                </div>
                <!-- Área de erro aumentada -->
                <p id="error-message" class="text-red-500 text-xs min-h-[1.5rem] text-center font-medium leading-tight px-2"></p>
                <button type="submit" id="submit-btn" class="w-full bg-green-700 text-white py-3 rounded-lg font-bold hover:bg-green-800 transition-colors shadow-md">ACESSAR SISTEMA</button>
            </form>
            <p class="text-center text-xs text-gray-500 mt-6">
                <a href="#" id="toggle-form-link" class="text-green-700 hover:underline font-semibold">Primeiro acesso? Criar conta</a>
            </p>

            <!-- LINKEDIN DISCRETO NA TELA DE LOGIN -->
            <div class="mt-8 text-center border-t border-gray-100 pt-4">
                <a href="https://www.linkedin.com/in/7icaaro" target="_blank" class="text-[10px] text-gray-300 hover:text-green-600 transition-colors duration-300 flex items-center justify-center gap-1 group">
                    <svg class="w-3 h-3 opacity-50 group-hover:opacity-100" fill="currentColor" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
                    <span>Dev: 7icaaro</span>
                </a>
            </div>
        </div>
    </div>

    <!-- PÁGINA DO KANBAN -->
    <div id="kanban-page" class="hidden flex flex-col min-h-screen relative">
        <!-- Cabeçalho -->
        <header class="bg-white border-b border-green-100 sticky top-0 z-40 shadow-sm">
            <div class="container mx-auto max-w-full px-4 md:px-6 py-3 flex flex-col md:flex-row justify-between md:items-center gap-4">
                <div class="flex items-center space-x-3 w-full md:w-auto">
                    <div class="bg-green-700 p-2 rounded-md shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/></svg>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-gray-800 leading-tight">Quadro de Manutenção</h1>
                        <p class="text-xs text-green-600 font-medium">Controle de Fluxo de Reparos</p>
                    </div>
                </div>
                
                <div class="flex flex-col sm:flex-row sm:items-center gap-3 w-full md:w-auto">
                    <!-- Controles Admin (PCM) -->
                    <div id="admin-controls" class="flex items-center space-x-2 hidden w-full sm:w-auto bg-green-50 px-3 py-1.5 rounded-md border border-green-200">
                        <span class="text-xs font-bold text-green-700 uppercase">Visão PCM:</span>
                        <select id="header-sort-select" class="bg-transparent text-sm text-gray-700 font-medium border-none focus:ring-0 outline-none cursor-pointer">
                            <option value="createdAt" selected>Mais Recentes</option>
                            <option value="priority">Por Criticidade</option>
                        </select>
                    </div>

                    <div class="h-6 w-px bg-gray-300 hidden sm:block"></div>

                    <!-- Botões de Ação -->
                    <div class="flex items-center space-x-2 w-full sm:w-auto">
                        <button id="add-task-btn" class="flex-1 sm:flex-none bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-bold transition-colors shadow-sm flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            Nova Solicitação
                        </button>
                        <button id="logout-btn" class="flex-1 sm:flex-none text-gray-500 hover:text-red-600 hover:bg-red-50 px-3 py-2 rounded-md text-sm font-medium transition-all border border-transparent hover:border-red-100">
                            Sair
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div id="auth-status" class="bg-green-800 text-green-100 text-[10px] text-center font-mono py-0.5">Autenticando...</div>

        <!-- Corpo do Kanban -->
        <main id="kanban-board" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 p-4 md:p-6 flex-grow overflow-x-auto items-start pb-8">
            
            <!-- Coluna: Pendente (Backlog) -->
            <div class="kanban-column flex flex-col h-full min-w-[280px]">
                <div class="flex justify-between items-center mb-3 px-1">
                    <div class="flex items-center gap-2">
                        <span class="w-2.5 h-2.5 rounded-full bg-gray-400"></span>
                        <h3 class="font-bold text-gray-700 text-sm uppercase tracking-wide">Aguardando</h3>
                    </div>
                    <span id="count-pendente" class="bg-gray-200 text-gray-600 px-2 py-0.5 rounded text-xs font-bold">0</span>
                </div>
                <div class="bg-gray-200/50 rounded-xl p-2 border border-gray-200 shadow-inner flex-grow">
                     <div id="col-pendente" class="space-y-3 kanban-column-body" data-column-id="pendente"></div>
                </div>
            </div>

            <!-- Coluna: Em Análise/Diagnóstico -->
            <div class="kanban-column flex flex-col h-full min-w-[280px]">
                <div class="flex justify-between items-center mb-3 px-1">
                    <div class="flex items-center gap-2">
                        <span class="w-2.5 h-2.5 rounded-full bg-yellow-500"></span>
                        <h3 class="font-bold text-gray-700 text-sm uppercase tracking-wide">Em Diagnóstico</h3>
                    </div>
                    <span id="count-analise" class="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded text-xs font-bold">0</span>
                </div>
                <div class="bg-yellow-50/50 rounded-xl p-2 border border-yellow-100 shadow-inner flex-grow">
                    <div id="col-analise" class="space-y-3 kanban-column-body" data-column-id="analise"></div>
                </div>
            </div>

            <!-- Coluna: Em Execução (Mantido Azul por convenção de status, mas suave) -->
            <div class="kanban-column flex flex-col h-full min-w-[280px]">
                <div class="flex justify-between items-center mb-3 px-1">
                    <div class="flex items-center gap-2">
                        <span class="w-2.5 h-2.5 rounded-full bg-blue-500"></span>
                        <h3 class="font-bold text-gray-700 text-sm uppercase tracking-wide">Em Execução</h3>
                    </div>
                    <span id="count-execucao" class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs font-bold">0</span>
                </div>
                <div class="bg-blue-50/50 rounded-xl p-2 border border-blue-100 shadow-inner flex-grow">
                    <div id="col-execucao" class="space-y-3 kanban-column-body" data-column-id="execucao"></div>
                </div>
            </div>

            <!-- Coluna: Concluído -->
            <div class="kanban-column flex flex-col h-full min-w-[280px]">
                <div class="flex justify-between items-center mb-3 px-1">
                    <div class="flex items-center gap-2">
                        <span class="w-2.5 h-2.5 rounded-full bg-green-500"></span>
                        <h3 class="font-bold text-gray-700 text-sm uppercase tracking-wide">Pronto / Entregue</h3>
                    </div>
                    <span id="count-concluido" class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-xs font-bold">0</span>
                </div>
                <div class="bg-green-50/50 rounded-xl p-2 border border-green-100 shadow-inner flex-grow">
                    <div id="col-concluido" class="space-y-3 kanban-column-body" data-column-id="concluido"></div>
                </div>
            </div>
        </main>

        <!-- LINKEDIN DISCRETO NA TELA PRINCIPAL (Fixo no canto inferior direito) -->
        <div class="fixed bottom-1 right-2 z-40 opacity-40 hover:opacity-100 transition-opacity duration-300">
            <a href="https://www.linkedin.com/in/7icaaro" target="_blank" class="text-[9px] font-medium text-gray-400 hover:text-green-700 bg-white/60 hover:bg-white px-2 py-1 rounded shadow-sm backdrop-blur-sm flex items-center gap-1">
                <svg class="w-2.5 h-2.5" fill="currentColor" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
                Dev: 7icaaro
            </a>
        </div>

        <!-- Modal Adicionar/Editar -->
        <div id="task-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4 hidden modal-transition opacity-0">
            <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full transform scale-95 opacity-0 overflow-hidden modal-content-transition" id="task-modal-content">
                <form id="task-form">
                    <!-- Header Modal -->
                    <div class="flex justify-between items-center px-6 py-4 border-b border-gray-100 bg-gray-50">
                        <div>
                            <h4 id="modal-title" class="text-lg font-bold text-gray-800">Nova Solicitação de Serviço</h4>
                            <p class="text-xs text-gray-500 mt-0.5">Preencha os dados técnicos para abertura da OS.</p>
                        </div>
                        <button type="button" id="close-modal-btn" class="text-gray-400 hover:text-gray-600 transition-colors p-1 rounded-full hover:bg-gray-200">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                    
                    <div class="p-6 space-y-6 max-h-[75vh] overflow-y-auto">
                        
                        <!-- Seção 1: Solicitante -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 bg-gray-50 rounded-lg border border-gray-100">
                            <div class="md:col-span-3 flex items-center gap-2 mb-1">
                                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                <h5 class="text-xs font-bold text-gray-600 uppercase">Dados do Solicitante</h5>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500 mb-1">Nome</label>
                                <input type="text" id="solicitante-nome" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-1 focus:ring-green-500 outline-none" required>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500 mb-1">Área / Setor</label>
                                <select id="solicitante-area" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm bg-white focus:ring-1 focus:ring-green-500 outline-none" required>
                                    <option value="" disabled selected>-</option>
                                    <option value="Envase">Envase</option>
                                    <option value="Processos">Processos</option>
                                    <option value="Utilidades">Utilidades</option>
                                    <option value="Logística">Logística</option>
                                    <option value="Qualidade">Qualidade</option>
                                    <option value="Predial">Predial</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500 mb-1">Email</label>
                                <input type="email" id="solicitante-email" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm bg-gray-100 text-gray-500 cursor-not-allowed" readonly>
                            </div>
                        </div>

                        <!-- Seção 2: Detalhes da Manutenção -->
                        <div class="space-y-4">
                            <div class="flex items-center gap-2 border-b border-gray-100 pb-2">
                                <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                <h5 class="text-sm font-bold text-gray-700">Detalhes Técnicos</h5>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="md:col-span-2">
                                    <label class="block text-xs font-medium text-gray-500 mb-1">Item / Equipamento (Título) *</label>
                                    <input type="text" id="item-titulo" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-1 focus:ring-green-500 outline-none placeholder-gray-400" placeholder="Ex: Motor da Esteira 04, Bomba Centrífuga B-201..." required>
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-medium text-gray-500 mb-1">Tipo de Serviço *</label>
                                    <select id="tipo-servico" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm bg-white focus:ring-1 focus:ring-green-500 outline-none" required>
                                        <option value="" disabled selected>Selecione...</option>
                                        <option value="Corretiva">Manutenção Corretiva</option>
                                        <option value="Preventiva">Preventiva / Programada</option>
                                        <option value="Eletrica">Elétrica / Automação</option>
                                        <option value="Solda">Solda / Caldeiraria</option>
                                        <option value="Usinagem">Usinagem / Ajuste</option>
                                        <option value="Melhoria">Projeto / Melhoria</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-xs font-medium text-gray-500 mb-1">TAG / Localização Física</label>
                                    <input type="text" id="equipamento-tag" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-1 focus:ring-green-500 outline-none" placeholder="Ex: TAG-M-200 ou Almoxarifado">
                                </div>

                                <div class="md:col-span-2">
                                    <label class="block text-xs font-medium text-gray-500 mb-1">Descrição da Falha / Solicitação *</label>
                                    <textarea id="descricao-falha" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-1 focus:ring-green-500 outline-none placeholder-gray-400" placeholder="Descreva o problema, ruídos anormais, peças quebradas, etc." required></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Seção 3: PCM / Admin -->
                        <div id="admin-fields" class="hidden space-y-4 bg-green-50 p-4 rounded-lg border border-green-100">
                            <div class="flex items-center gap-2 border-b border-green-200 pb-2">
                                <svg class="w-4 h-4 text-green-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                                <h5 class="text-sm font-bold text-green-900">Planejamento (PCM/Liderança)</h5>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-green-800 mb-1">Criticidade</label>
                                    <select id="admin-prioridade" class="w-full px-3 py-2 border border-green-200 rounded-md text-sm bg-white">
                                        <option value="3">Baixa (Planejável)</option>
                                        <option value="2" selected>Média (Atenção)</option>
                                        <option value="1">Alta (Parada de Linha)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-green-800 mb-1">Técnico Responsável</label>
                                    <input type="text" id="admin-tecnico" class="w-full px-3 py-2 border border-green-200 rounded-md text-sm" placeholder="Nome do Técnico">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-green-800 mb-1">Prazo Estimado</label>
                                    <input type="date" id="admin-prazo" class="w-full px-3 py-2 border border-green-200 rounded-md text-sm">
                                </div>
                            </div>
                        </div>

                        <input type="hidden" id="task-id-hidden">
                        <p id="modal-error-message" class="text-red-500 text-xs h-4 font-medium"></p>
                    </div>
                    
                    <!-- Footer Modal -->
                    <div class="flex justify-end items-center space-x-3 px-6 py-4 bg-gray-50 border-t border-gray-100 rounded-b-xl">
                        <button type="button" id="cancel-modal-btn" class="px-4 py-2 rounded-md bg-white border border-gray-300 text-gray-700 text-sm font-medium hover:bg-gray-50 transition-colors">Cancelar</button>
                        <button type="submit" id="save-task-btn" class="px-6 py-2 rounded-md bg-green-700 text-white text-sm font-bold hover:bg-green-800 shadow-md transition-colors">
                            Salvar Solicitação
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal Exclusão -->
        <div id="delete-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4 hidden modal-transition opacity-0">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform scale-95 opacity-0 modal-content-transition text-center" id="delete-modal-content">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </div>
                <h4 class="text-lg font-bold text-gray-900 mb-2">Arquivar Solicitação?</h4>
                <p class="text-sm text-gray-500 mb-6">Esta ação removerá a OS do quadro. Certifique-se de que o serviço foi cancelado ou arquivado.</p>
                <div class="flex justify-center space-x-3">
                    <button id="cancel-delete-btn" class="px-4 py-2 rounded-md bg-white border border-gray-300 text-gray-700 text-sm font-medium hover:bg-gray-50">Cancelar</button>
                    <button id="confirm-delete-btn" class="px-4 py-2 rounded-md bg-red-600 text-white text-sm font-bold hover:bg-red-700 shadow-md">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- FIREBASE (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        // 1. CONFIGURAÇÃO DO FIREBASE
        const firebaseConfig = {
          apiKey: "AIzaSyBBrp0r27bdq0_Giw-OcefyGTgtNny2U_g",
          authDomain: "gfyfy7fy.firebaseapp.com",
          databaseURL: "https://gfyfy7fy-default-rtdb.firebaseio.com",
          projectId: "gfyfy7fy",
          storageBucket: "gfyfy7fy.firebasestorage.app",
          messagingSenderId: "55023990965",
          appId: "1:55023990965:web:227802c9e20ba07f6f26fc",
          measurementId: "G-WK5QQDSC4Y"
        };

        const appId = firebaseConfig.projectId;
        let app, auth, db;
        try {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.database();
        } catch (e) {
            console.error("Erro Firebase:", e);
            return;
        }

        // 2. VARIÁVEIS E ELEMENTOS
        let currentUser = null, userUid = null, userRole = 'user';
        let dbTasksRef = null, taskToDeleteId = null;
        let allTasks = {}, sortables = [];

        const loginPage = document.getElementById('login-page');
        const kanbanPage = document.getElementById('kanban-page');
        const authForm = document.getElementById('auth-form');
        const submitBtn = document.getElementById('submit-btn');
        const toggleFormLink = document.getElementById('toggle-form-link');
        const errorMessage = document.getElementById('error-message');
        let isLoginMode = true;

        // Mapeamento das novas colunas de manutenção
        const columns = { 
            "pendente": document.getElementById('col-pendente'), 
            "analise": document.getElementById('col-analise'), 
            "execucao": document.getElementById('col-execucao'), 
            "concluido": document.getElementById('col-concluido') 
        };
        const columnIds = Object.keys(columns);
        const columnCounts = { 
            "pendente": document.getElementById('count-pendente'), 
            "analise": document.getElementById('count-analise'), 
            "execucao": document.getElementById('count-execucao'), 
            "concluido": document.getElementById('count-concluido') 
        };

        const taskModal = document.getElementById('task-modal');
        const taskForm = document.getElementById('task-form');
        const deleteModal = document.getElementById('delete-modal');

        // 3. AUTENTICAÇÃO
        toggleFormLink.addEventListener('click', (e) => {
            e.preventDefault();
            isLoginMode = !isLoginMode;
            document.getElementById('form-title').textContent = isLoginMode ? 'Manutenção Central' : 'Cadastro de Técnico';
            submitBtn.textContent = isLoginMode ? 'ACESSAR SISTEMA' : 'CRIAR CONTA';
            toggleFormLink.textContent = isLoginMode ? 'Primeiro acesso? Criar conta' : 'Já tem acesso? Entrar';
            errorMessage.textContent = '';
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = authForm.email.value;
            const password = authForm.password.value;
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
            try {
                if (isLoginMode) {
                    await auth.signInWithEmailAndPassword(email, password);
                } else {
                    const cred = await auth.createUserWithEmailAndPassword(email, password);
                    await db.ref(`/artifacts/${appId}/users/${cred.user.uid}`).set({ email: cred.user.email, role: 'user' });
                }
            } catch (error) {
                console.error("Erro Firebase Detalhado:", error); // Mostra no console do navegador (F12)
                
                let msg = "Erro: " + error.message; // Padrão: Mostra a mensagem técnica em inglês se não mapeado

                // Tratamento de erros comuns
                if (error.code === 'auth/wrong-password') msg = "Senha incorreta.";
                else if (error.code === 'auth/user-not-found') msg = "Usuário não encontrado.";
                else if (error.code === 'auth/email-already-in-use') msg = "Email já cadastrado.";
                else if (error.code === 'auth/weak-password') msg = "A senha deve ter pelo menos 6 caracteres.";
                else if (error.code === 'auth/invalid-email') msg = "O formato do email é inválido.";
                else if (error.code === 'auth/operation-not-allowed') msg = "Erro de Configuração: Ative 'Email/Password' no Console do Firebase.";
                else if (error.code === 'auth/network-request-failed') msg = "Erro de Conexão. Verifique sua internet.";
                else if (error.code === 'auth/too-many-requests') msg = "Muitas tentativas falhas. O acesso foi temporariamente bloqueado. Aguarde alguns minutos.";
                
                errorMessage.textContent = msg;
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user; userUid = user.uid;
                kanbanPage.classList.remove('hidden');
                loginPage.classList.add('hidden');
                
                db.ref(`/artifacts/${appId}/users/${user.uid}/role`).on('value', (snap) => {
                    userRole = (snap.exists() && snap.val() === 'admin') ? 'admin' : 'user';
                    document.getElementById('auth-status').textContent = `Logado: ${user.email} | Perfil: ${userRole === 'admin' ? 'PCM / Líder' : 'Técnico / Solicitante'}`;
                    updateUIForRole();
                    initRealtimeListener();
                    initSortable();
                });
            } else {
                currentUser = null; userUid = null; userRole = 'user';
                if (dbTasksRef) dbTasksRef.off();
                kanbanPage.classList.add('hidden');
                loginPage.classList.remove('hidden');
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                errorMessage.textContent = '';
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());

        function updateUIForRole() {
            const adminControls = document.getElementById('admin-controls');
            if(userRole === 'admin') {
                adminControls.classList.remove('hidden');
            } else {
                adminControls.classList.add('hidden');
            }
            renderAllTasks();
        }

        // 4. DATABASE (Contexto de Manutenção)
        const publicTasksPath = `/artifacts/${appId}/public/data/maintenanceJobs`; 
        const writeTasksRef = db.ref(publicTasksPath);

        function initRealtimeListener() {
            if (dbTasksRef) dbTasksRef.off();
            columnIds.forEach(id => columns[id].innerHTML = '');
            allTasks = {};

            // Lógica de visualização
            // Se for Admin (PCM), vê tudo. Se for User, vê apenas o que criou OU (Opcional: podemos deixar todos verem tudo para transparência na manutenção)
            // Vamos deixar todos verem tudo para seguir o princípio de "Gestão Visual" do Kanban
            dbTasksRef = db.ref(publicTasksPath);

            const updateTask = (snap) => { 
                if(snap.val()) { allTasks[snap.key] = { id: snap.key, ...snap.val() }; renderAllTasks(); } 
            };
            dbTasksRef.on('child_added', updateTask);
            dbTasksRef.on('child_changed', updateTask);
            dbTasksRef.on('child_removed', (snap) => { delete allTasks[snap.key]; renderAllTasks(); });
        }

        document.getElementById('header-sort-select').addEventListener('change', renderAllTasks);

        function renderAllTasks() {
            columnIds.forEach(id => columns[id].innerHTML = '');
            let tasksArray = Object.values(allTasks);
            
            const sortValue = document.getElementById('header-sort-select').value;
            if (sortValue === 'priority') {
                tasksArray.sort((a, b) => (a.criticidade || 2) - (b.criticidade || 2));
            } else {
                tasksArray.sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));
            }

            tasksArray.forEach(task => {
                const colId = task.status || 'pendente';
                if (columns[colId]) columns[colId].appendChild(createTaskElement(task));
            });
            
            // Atualiza contadores
            columnIds.forEach(id => columnCounts[id].textContent = columns[id].children.length);
        }

        // Helpers visuais
        function getCriticidadeStyle(nivel) {
             if (nivel == '1') return { bg: 'bg-red-100', text: 'text-red-700', border: 'border-l-4 border-red-500', label: 'ALTA' }; 
             if (nivel == '3') return { bg: 'bg-blue-50', text: 'text-blue-600', border: 'border-l-4 border-blue-300', label: 'BAIXA' }; 
             return { bg: 'bg-white', text: 'text-gray-600', border: 'border-l-4 border-yellow-400', label: 'MÉDIA' }; // Padrão
        }

        function getServiceBadgeColor(type) {
            switch(type) {
                case 'Corretiva': return 'bg-red-100 text-red-700';
                case 'Preventiva': return 'bg-green-100 text-green-700';
                case 'Eletrica': return 'bg-yellow-100 text-yellow-700';
                default: return 'bg-gray-100 text-gray-600';
            }
        }

        function createTaskElement(task) {
            const style = getCriticidadeStyle(task.criticidade);
            const serviceStyle = getServiceBadgeColor(task.tipoServico);
            
            const card = document.createElement('div');
            card.className = `bg-white p-3 rounded-lg shadow-sm border border-gray-200 ${style.border} group relative hover:shadow-md transition-all duration-200 cursor-pointer`;
            card.dataset.taskId = task.id;

            const titulo = DOMPurify.sanitize(task.itemTitulo);
            const servico = task.tipoServico || 'Geral';
            const data = task.createdAt ? new Date(task.createdAt).toLocaleDateString('pt-BR') : '--/--';
            const tecnico = task.tecnicoResponsavel ? `<div class="flex items-center gap-1 mt-2 text-xs font-semibold text-green-800"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg> ${DOMPurify.sanitize(task.tecnicoResponsavel)}</div>` : '';

            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <span class="badge-service ${serviceStyle}">${servico}</span>
                    <span class="text-[10px] text-gray-400 font-mono">${data}</span>
                </div>
                <h4 class="text-sm font-bold text-gray-800 mb-1 leading-snug line-clamp-2">${titulo || 'Sem título'}</h4>
                <p class="text-xs text-gray-500 line-clamp-2 mb-2">${DOMPurify.sanitize(task.descricaoFalha || '')}</p>
                
                <div class="border-t border-gray-100 pt-2 mt-1 flex justify-between items-center">
                    <span class="text-[10px] font-bold ${style.text}">${style.label}</span>
                    <div class="text-[10px] text-gray-400">${task.solicitanteArea || 'N/A'}</div>
                </div>
                ${tecnico}
                
                <!-- Botão de Excluir (Só aparece no hover e se for admin) -->
                <button class="delete-task-btn hidden group-hover:flex absolute top-2 right-2 bg-white rounded-full p-1 text-gray-400 hover:text-red-600 shadow-sm border border-gray-100" title="Arquivar">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            `;

            // Evento de clique no card para editar
            card.addEventListener('click', (e) => {
                if(!e.target.closest('.delete-task-btn')) openTaskModal('edit', task.id);
            });
            
            const delBtn = card.querySelector('.delete-task-btn');
            if(delBtn) {
                if (userRole === 'admin') {
                    delBtn.classList.remove('hidden');
                    delBtn.addEventListener('click', (e) => { 
                        e.stopPropagation(); 
                        showDeleteModal(task.id); 
                    });
                } else {
                    delBtn.remove();
                }
            }

            return card;
        }

        // 5. MODAIS E AÇÕES
        function showModal(m, c) { 
            m.classList.remove('hidden'); 
            setTimeout(() => { 
                m.classList.remove('opacity-0'); 
                c.classList.remove('scale-95','opacity-0'); 
                c.classList.add('scale-100','opacity-100'); 
            }, 10); 
        }
        function hideModal(m, c) { 
            c.classList.remove('scale-100','opacity-100'); 
            c.classList.add('scale-95','opacity-0'); 
            m.classList.add('opacity-0'); 
            setTimeout(() => m.classList.add('hidden'), 200); 
        }

        document.getElementById('add-task-btn').addEventListener('click', () => openTaskModal('add'));
        document.getElementById('close-modal-btn').addEventListener('click', () => hideModal(taskModal, document.getElementById('task-modal-content')));
        document.getElementById('cancel-modal-btn').addEventListener('click', () => hideModal(taskModal, document.getElementById('task-modal-content')));

        function openTaskModal(mode, taskId) {
            taskForm.reset();
            document.getElementById('modal-error-message').textContent = '';
            document.getElementById('task-id-hidden').value = mode === 'edit' ? taskId : '';
            document.getElementById('admin-fields').classList.add('hidden');

            // Preenchimento Automático (Se for 'add')
            if (mode === 'add' && currentUser) {
                document.getElementById('solicitante-email').value = currentUser.email;
            }

            document.getElementById('modal-title').textContent = mode === 'edit' ? 'Editar Solicitação' : 'Nova Solicitação de Serviço';

            // Se for Admin ou Edição, lógica de preenchimento
            if (mode === 'edit') {
                const task = allTasks[taskId];
                if(!task) return;

                // Admin vê campos de PCM
                if (userRole === 'admin') document.getElementById('admin-fields').classList.remove('hidden');
                
                document.getElementById('solicitante-nome').value = task.solicitanteNome || '';
                document.getElementById('solicitante-area').value = task.solicitanteArea || '';
                document.getElementById('solicitante-email').value = task.solicitanteEmail || '';
                
                document.getElementById('item-titulo').value = task.itemTitulo || '';
                document.getElementById('tipo-servico').value = task.tipoServico || '';
                document.getElementById('equipamento-tag').value = task.equipamentoTag || '';
                document.getElementById('descricao-falha').value = task.descricaoFalha || '';

                // Admin fields
                document.getElementById('admin-prioridade').value = task.criticidade || '2';
                document.getElementById('admin-tecnico').value = task.tecnicoResponsavel || '';
                document.getElementById('admin-prazo').value = task.prazoEstimado || '';
            } else {
                // Se for 'add' e for admin, pode ver os campos de admin logo de cara? 
                // Opcional. Vamos deixar escondido para simplificar a abertura.
            }
            showModal(taskModal, document.getElementById('task-modal-content'));
        }

        taskForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('save-task-btn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = "Processando...";

            const id = document.getElementById('task-id-hidden').value;
            
            // Dados Base (Solicitante + Técnico)
            const data = {
                solicitanteNome: document.getElementById('solicitante-nome').value,
                solicitanteArea: document.getElementById('solicitante-area').value,
                solicitanteEmail: document.getElementById('solicitante-email').value,
                itemTitulo: document.getElementById('item-titulo').value,
                tipoServico: document.getElementById('tipo-servico').value,
                equipamentoTag: document.getElementById('equipamento-tag').value,
                descricaoFalha: document.getElementById('descricao-falha').value
            };

            // Dados Admin (PCM)
            // Se for admin editando, atualiza tudo. Se for user, não mexe na criticidade.
            if (userRole === 'admin') {
                data.criticidade = document.getElementById('admin-prioridade').value;
                data.tecnicoResponsavel = document.getElementById('admin-tecnico').value;
                data.prazoEstimado = document.getElementById('admin-prazo').value;
            }

            try {
                if (id) {
                    await writeTasksRef.child(id).update(data);
                } else {
                    data.createdBy = userUid;
                    data.createdAt = firebase.database.ServerValue.TIMESTAMP;
                    data.status = 'pendente'; // Status inicial padrão
                    if (!data.criticidade) data.criticidade = '2'; // Padrão Média
                    await writeTasksRef.push(data);
                }
                hideModal(taskModal, document.getElementById('task-modal-content'));
            } catch (err) {
                document.getElementById('modal-error-message').textContent = "Erro: " + err.message;
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        });

        function showDeleteModal(id) { 
            taskToDeleteId = id; 
            showModal(deleteModal, document.getElementById('delete-modal-content')); 
        }
        document.getElementById('cancel-delete-btn').addEventListener('click', () => hideModal(deleteModal, document.getElementById('delete-modal-content')));
        
        document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
            if (taskToDeleteId && userRole === 'admin') {
                try {
                    await writeTasksRef.child(taskToDeleteId).remove();
                    hideModal(deleteModal, document.getElementById('delete-modal-content'));
                } catch(err) {
                    alert("Erro: " + err.message);
                }
            }
        });

        // 6. DRAG AND DROP
        function initSortable() {
            sortables.forEach(s => s.destroy());
            sortables = [];
            
            // Permitir drag para todos para fluidez na oficina, ou restringir a admin.
            // Vamos restringir a admin (Líderes/PCM) para evitar movimentação acidental.
            const isDisabled = userRole !== 'admin';

            columnIds.forEach(colId => {
                const el = columns[colId];
                if(!el) return;

                sortables.push(new Sortable(el, {
                    group: 'kanban', 
                    animation: 200,
                    ghostClass: 'sortable-ghost', 
                    chosenClass: 'sortable-chosen',
                    delay: 150, 
                    delayOnTouchOnly: true,
                    disabled: isDisabled, 
                    onEnd: (evt) => {
                        if (evt.to.dataset.columnId !== evt.from.dataset.columnId) {
                            const taskId = evt.item.dataset.taskId;
                            const newStatus = evt.to.dataset.columnId;
                            writeTasksRef.child(taskId).update({ status: newStatus });
                        }
                    }
                }));
            });
        }
    });
    </script>
</body>
</html>
