<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban PCM - Heineken</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Sortable.js (Drag and Drop) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <!-- DOMPurify (Segurança) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <!-- Fonte -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .sortable-ghost { opacity: 0.3; background: #dbeafe; border: 2px dashed #60a5fa; }
        .sortable-chosen { cursor: grabbing; opacity: 0.9; transform: scale(1.02); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .kanban-column-body { max-height: 75vh; overflow-y: auto; }
    </style>
</head>
<body class="antialiased text-gray-900">

<!-- Cabeçalho -->
<header class="bg-green-800 text-white shadow-lg sticky top-0 z-40">
    <div class="container mx-auto max-w-full px-4 md:px-8 py-4 flex justify-between items-center">
        <!-- Logo e Título -->
        <div class="flex items-center space-x-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-green-300" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.5 12a7.5 7.5 0 0 0 15 0"/></svg>
            <div class="flex items-center space-x-3">
                <div>
                    <h1 class="text-2xl font-bold">Kanban Peças</h1>
                    <p class="text-sm text-gray-200 font-light">Cervejaria Heineken</p>
                </div>
            </div>
        </div>
        <!-- Botões de Ação -->
        <div class="flex items-center space-x-3">
            <div class="flex items-center space-x-2 mr-2">
                <label for="header-priority-select" class="text-sm font-medium sr-only">Prioridade Padrão</label>
                <select id="header-priority-select" class="px-3 py-2 rounded-lg bg-white text-gray-800 text-sm border border-green-600">
                    <option value="all" selected>Todas</option>
                    <option value="low">Baixa</option>
                    <option value="medium">Média</option>
                    <option value="high">Alta</option>
                </select>
            </div>
            <div class="flex items-center space-x-2 mr-2">
                <span class="text-sm text-white font-medium">Prioridade</span>
                <span id="title-priority-badge" class="text-xs font-semibold px-2 py-1 rounded-full bg-orange-500 text-white">Média</span>
            </div>
            <button id="add-task-btn" class="bg-green-600 hover:bg-green-700 px-5 py-2 rounded-lg font-semibold transition-colors">Adicionar</button>
            <button id="logout-btn" class="bg-green-500 text-white px-3 py-2 rounded-lg border border-green-600 text-sm font-medium hover:bg-red-600 hover:border-red-700 transition-colors">Sair</button>
        </div>
    </div>
</header>

<!-- Barra de Status da Autenticação -->
<div id="auth-status" class="py-2 px-6 bg-green-900 text-green-200 text-sm text-center sticky top-[80px] z-30">A conectar...</div>

<!-- Corpo Principal do Kanban -->
<main id="kanban-board" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6 p-6">
    
    <!-- Coluna 1: A RESTAURAR -->
    <div class="kanban-column bg-white rounded-xl shadow-lg flex flex-col">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center sticky top-[124px] bg-white rounded-t-xl z-10">
            <div class="flex items-center space-x-3">
                <span class="w-3 h-3 bg-red-500 rounded-full"></span>
                <h3 class="font-semibold text-red-600 uppercase text-sm">A RESTAURAR</h3>
            </div>
            <span id="count-col-restaurar" class="px-2.5 py-0.5 bg-gray-200 text-gray-700 rounded-full font-semibold text-xs">0</span>
        </div>
        <div id="col-restaurar" class="p-4 space-y-4 kanban-column-body flex-grow min-h-[200px]" data-column-id="col-restaurar"></div>
    </div>

    <!-- Coluna 2: EM DIAGNÓSTICO -->
    <div class="kanban-column bg-white rounded-xl shadow-lg flex flex-col">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center sticky top-[124px] bg-white rounded-t-xl z-10">
            <div class="flex items-center space-x-3">
                <span class="w-3 h-3 bg-yellow-500 rounded-full"></span>
                <h3 class="font-semibold text-yellow-600 uppercase text-sm">EM DIAGNÓSTICO</h3>
            </div>
            <span id="count-col-diagnostico" class="px-2.5 py-0.5 bg-gray-200 text-gray-700 rounded-full font-semibold text-xs">0</span>
        </div>
        <div id="col-diagnostico" class="p-4 space-y-4 kanban-column-body flex-grow min-h-[200px]" data-column-id="col-diagnostico"></div>
    </div>

    <!-- Coluna 3: EM RESTAURAÇÃO -->
    <div class="kanban-column bg-white rounded-xl shadow-lg flex flex-col">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center sticky top-[124px] bg-white rounded-t-xl z-10">
            <div class="flex items-center space-x-3">
                <span class="w-3 h-3 bg-orange-500 rounded-full"></span>
                <h3 class="font-semibold text-orange-600 uppercase text-sm">EM RESTAURAÇÃO</h3>
            </div>
            <span id="count-col-restauracao" class="px-2.5 py-0.5 bg-gray-200 text-gray-700 rounded-full font-semibold text-xs">0</span>
        </div>
        <div id="col-restauracao" class="p-4 space-y-4 kanban-column-body flex-grow min-h-[200px]" data-column-id="col-restauracao"></div>
    </div>

    <!-- Coluna 4: EM TESTE / QUALIDADE -->
    <div class="kanban-column bg-white rounded-xl shadow-lg flex flex-col">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center sticky top-[124px] bg-white rounded-t-xl z-10">
            <div class="flex items-center space-x-3">
                <span class="w-3 h-3 bg-blue-500 rounded-full"></span>
                <h3 class="font-semibold text-blue-600 uppercase text-sm">EM TESTE / QUALIDADE</h3>
            </div>
            <span id="count-col-teste" class="px-2.5 py-0.5 bg-gray-200 text-gray-700 rounded-full font-semibold text-xs">0</span>
        </div>
        <div id="col-teste" class="p-4 space-y-4 kanban-column-body flex-grow min-h-[200px]" data-column-id="col-teste"></div>
    </div>

    <!-- Coluna 5: PRONTO PARA USO -->
    <div class="kanban-column bg-white rounded-xl shadow-lg flex flex-col">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center sticky top-[124px] bg-white rounded-t-xl z-10">
            <div class="flex items-center space-x-3">
                <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                <h3 class="font-semibold text-green-600 uppercase text-sm">PRONTO PARA USO</h3>
            </div>
            <span id="count-col-pronto" class="px-2.5 py-0.5 bg-gray-200 text-gray-700 rounded-full font-semibold text-xs">0</span>
        </div>
        <div id="col-pronto" class="p-4 space-y-4 kanban-column-body flex-grow min-h-[200px]" data-column-id="col-pronto"></div>
    </div>
</main>

<!-- Modal de Adicionar/Editar Tarefa -->
<div id="task-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 hidden">
    <div class="bg-white rounded-lg shadow-2xl max-w-lg w-full transform scale-95 opacity-0" id="task-modal-content">
        <form id="task-form">
            <div class="flex justify-between items-center p-5 border-b border-gray-200">
                <h4 id="modal-title" class="text-2xl font-semibold text-gray-800">Adicionar</h4>
                <button type="button" id="close-modal-btn" class="text-gray-400 hover:text-gray-600">✕</button>
            </div>
            <div class="p-6 space-y-5">
                <div>
                    <label for="task-id-input" class="block text-sm font-medium text-gray-700 mb-1">Nº / Código (Obrigatório)</label>
                    <input type="text" id="task-id-input" placeholder="Ex: OS-45102" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    <p id="task-id-display" class="text-lg font-medium text-gray-600 hidden"></p>
                </div>
                <div>
                    <label for="task-text-input" class="block text-sm font-medium text-gray-700 mb-1">Descrição do Serviço <span class="text-red-500">*</span></label>
                    <textarea id="task-text-input" rows="4" placeholder="Descreva o serviço..." class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></textarea>
                </div>
                <div>
                    <label for="task-priority-input" class="block text-sm font-medium text-gray-700 mb-1">Prioridade</label>
                    <select id="task-priority-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                        <option value="low">Baixa</option>
                        <option value="medium" selected>Média</option>
                        <option value="high">Alta</option>
                    </select>
                </div>
                <input type="hidden" id="task-id-hidden">
                <p id="modal-error-message" class="text-red-500 text-sm h-5"></p>
            </div>
                <div class="flex justify-end items-center space-x-4 p-5 bg-gray-50 rounded-b-lg">
                <button type="button" id="cancel-modal-btn" class="px-5 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 transition-colors">Cancelar</button>
                <button type="submit" id="save-task-btn" class="px-6 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 transition-colors">Salvar</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal de Confirmação de Exclusão -->
<div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 hidden">
    <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full transform scale-95 opacity-0" id="delete-modal-content">
        <h4 class="text-xl font-semibold mb-4">Confirmar exclusão</h4>
        <p class="text-gray-600 mb-6">Tem certeza de que deseja excluir este item?</p>
        <div class="flex justify-end space-x-3">
            <button id="cancel-delete-btn" class="px-5 py-2 rounded-lg bg-gray-300 hover:bg-gray-400 transition-colors">Cancelar</button>
            <button id="confirm-delete-btn" class="px-5 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 transition-colors">Excluir</button>
        </div>
    </div>
</div>

<!--
    ! IMPORTANTE!
    Usamos as versões -compat para compatibilidade com a sintaxe estilo v8.
    Agora trocamos Firestore pelo Realtime Database (database-compat).
-->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    
    // --- 1. CONFIGURAÇÃO DO FIREBASE ---
    // Configuração do Firebase (fornecida pelo usuário)
    const firebaseConfig = {
        apiKey: "AIzaSyBBrp0r27bdq0_Giw-OcefyGTgtNny2U_g",
        authDomain: "gfyfy7fy.firebaseapp.com",
        databaseURL: "https://gfyfy7fy-default-rtdb.firebaseio.com",
        projectId: "gfyfy7fy",
        storageBucket: "gfyfy7fy.firebasestorage.app",
        messagingSenderId: "55023990965",
        appId: "1:55023990965:web:227802c9e20ba07f6f26fc",
        measurementId: "G-WK5QQDSC4Y"
    };

    // Inicializa o Firebase (Realtime Database compat)
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // --- 2. VARIÁVEIS GLOBAIS E ESTADO ---
    let currentUser = null;
    let userUid = null;
    let userRole = 'user'; // ADICIONADO: Função do utilizador (padrão 'user')
    let dbTasksRef = null; // Referência de LEITURA (pode ser filtrada)
    let writeTasksRef = null; // ADICIONADO: Referência de ESCRITA (sempre no caminho principal)
    let taskToDeleteId = null;
    let unsubscribeSnapshot = null; // Função para parar de ouvir o DB
    let unsubscribeRole = null; // ADICIONADO: Função para parar de ouvir a Função (role)

    // --- 3. MAPEAMENTO DE ELEMENTOS DO DOM ---
    const authStatus = document.getElementById('auth-status');
    const logoutBtn = document.getElementById('logout-btn');
    const addTaskBtn = document.getElementById('add-task-btn');
    const headerPrioritySelect = document.getElementById('header-priority-select');

    const columns = {
        "col-restaurar": document.getElementById('col-restaurar'),
        "col-diagnostico": document.getElementById('col-diagnostico'),
        "col-restauracao": document.getElementById('col-restauracao'),
        "col-teste": document.getElementById('col-teste'),
        "col-pronto": document.getElementById('col-pronto')
    };
    const columnIds = Object.keys(columns);
    const columnCounts = {
        "col-restaurar": document.getElementById('count-col-restaurar'),
        "col-diagnostico": document.getElementById('count-col-diagnostico'),
        "col-restauracao": document.getElementById('count-col-restauracao'),
        "col-teste": document.getElementById('count-col-teste'),
        "col-pronto": document.getElementById('count-col-pronto')
    };

    // Modais
    const taskModal = document.getElementById('task-modal');
    const taskModalContent = document.getElementById('task-modal-content');
    const taskForm = document.getElementById('task-form');
    const modalTitle = document.getElementById('modal-title');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const cancelModalBtn = document.getElementById('cancel-modal-btn');
    const saveTaskBtn = document.getElementById('save-task-btn');
    const taskIdInput = document.getElementById('task-id-input');
    const taskIdDisplay = document.getElementById('task-id-display');
    const taskTextInput = document.getElementById('task-text-input');
    const taskPriorityInput = document.getElementById('task-priority-input');
    const taskIdHidden = document.getElementById('task-id-hidden');
    const modalErrorMessage = document.getElementById('modal-error-message');
    
    const deleteModal = document.getElementById('delete-modal');
    const deleteModalContent = document.getElementById('delete-modal-content');
    const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');


    // --- 4. LÓGICA DE AUTENTICAÇÃO ---

    auth.onAuthStateChanged(user => {
        if (user) {
            // Usuário está logado
            currentUser = user;
            userUid = user.uid;
            
            // Limpa listeners antigos (se houver)
            if (unsubscribeSnapshot) unsubscribeSnapshot();
            if (unsubscribeRole) unsubscribeRole();

            const userName = user.email.split('@')[0];
            authStatus.textContent = `A verificar permissões...`;

            // --- LÓGICA DE FUNÇÃO (ROLE) ADICIONADA ---
            // 1. Ouve a função (role) do utilizador
            const userRoleRef = db.ref('user_roles/' + userUid);
            unsubscribeRole = userRoleRef.on('value', (snap) => {
                if (snap.exists() && snap.val().role === 'admin') {
                    userRole = 'admin';
                    authStatus.textContent = `Conectado como: ${userName.charAt(0).toUpperCase() + userName.slice(1)} (ADMIN)`;
                } else {
                    userRole = 'user';
                    authStatus.textContent = `Conectado como: ${userName.charAt(0).toUpperCase() + userName.slice(1)} (Utilizador)`;
                }
                
                // 2. Inicializa o Kanban SÓ DEPOIS de saber a função
                initializeKanbanForRole(userRole, userUid);
            });


        } else {
            // Usuário não está logado
            currentUser = null;
            userUid = null;
            userRole = 'user'; // Resetar
            
            // Para de ouvir o banco de dados
            if (unsubscribeSnapshot) unsubscribeSnapshot();
            if (unsubscribeRole) unsubscribeRole();

            // Redireciona para a página de login
            window.location.href = './login.html'; // <-- CORRIGIDO
        }
    });

    // Evento de Logout
    logoutBtn.addEventListener('click', () => {
        // CORREÇÃO: Removido o 'confirm()' que bloqueava a execução
        
        // Para de ouvir o banco de dados antes de sair
        if (unsubscribeSnapshot) unsubscribeSnapshot();
        if (unsubscribeRole) unsubscribeRole();
        auth.signOut();
        
    });

    // --- 5. LÓGICA DO BANCO DE DADOS (Realtime Database) ---

    /**
     * Define as referências de LEITURA e ESCRITA e inicia os listeners
     * com base na função (role) do utilizador.
     */
    function initializeKanbanForRole(role, uid) {
        if (unsubscribeSnapshot) unsubscribeSnapshot(); // Limpa listeners antigos
        
        // Define o caminho público para as tarefas
        const publicTasksPath = 'public_tasks';
        
        // A Referência de ESCRITA é sempre a principal (sem filtros)
        writeTasksRef = db.ref(publicTasksPath);

        // A Referência de LEITURA (dbTasksRef) depende da função
        if (role === 'admin') {
            // Admin vê tudo
            dbTasksRef = writeTasksRef;
        } else {
            // User vê apenas o que criou
            dbTasksRef = writeTasksRef.orderByChild('createdBy').equalTo(uid);
        }

        // Inicializa o quadro (com as permissões corretas)
        initRealtimeListener();
        initSortable(role); // Passa a função para o Sortable
    }


    function initRealtimeListener() {
        if (!dbTasksRef) return;

        // Limpa o quadro (para o caso de troca de usuário, etc.)
        columnIds.forEach(id => columns[id].innerHTML = '');

        // Handlers para eventos child_added / child_changed / child_removed
        const onChildAdded = (snap) => {
            const task = snap.val();
            const taskId = snap.key;
            if (!task) return;
            // *** CORREÇÃO: Renomeada a variável para evitar conflito ***
            const cardExists = document.querySelector(`[data-task-id="${taskId}"]`);
            if (cardExists) return; // evita duplicatas
                const newCard = createTaskElement(task, taskId);
            const colId = task.column || 'col-restaurar';
            if (columns[colId]) columns[colId].appendChild(newCard);
            // Aplica filtro atual e atualiza contadores
            applyPriorityFilter();
            // Se o card adicionado estiver oculto pelo filtro, simplesmente não contarão
            updateAllCounts();
        };

        const onChildChanged = (snap) => {
            const task = snap.val();
            const taskId = snap.key;
            if (!task) return;
            // *** CORREÇÃO: Renomeada a variável para evitar conflito ***
            const cardToUpdate = document.querySelector(`[data-task-id="${taskId}"]`);
            const newColId = task.column || 'col-restaurar';
            const updatedCard = createTaskElement(task, taskId); // <-- Passa o taskId

            if (cardToUpdate) {
                if (cardToUpdate.parentElement.dataset.columnId !== newColId) {
                    columns[newColId].appendChild(updatedCard);
                    cardToUpdate.remove();
                } else {
                    cardToUpdate.replaceWith(updatedCard);
                }
            } else if (columns[newColId]) {
                columns[newColId].appendChild(updatedCard);
            }
            // Aplica filtro atual e atualiza contadores
            applyPriorityFilter();
            updateAllCounts();
        };

        const onChildRemoved = (snap) => {
            const taskId = snap.key;
            const existingCard = document.querySelector(`[data-task-id="${taskId}"]`);
            if (existingCard) existingCard.remove();
            // Aplica filtro atual e atualiza contadores
            applyPriorityFilter();
            updateAllCounts();
        };

        // Registra os listeners
        dbTasksRef.on('child_added', onChildAdded);
        dbTasksRef.on('child_changed', onChildChanged);
        dbTasksRef.on('child_removed', onChildRemoved);

        // Função para remover os listeners (usada no logout/troca de usuário)
        unsubscribeSnapshot = () => {
            if (dbTasksRef) {
                dbTasksRef.off('child_added', onChildAdded);
                dbTasksRef.off('child_changed', onChildChanged);
                dbTasksRef.off('child_removed', onChildRemoved);
            }
        };
    }

    /**
     * Atualiza os contadores de todas as colunas.
     */
    function updateAllCounts() {
        columnIds.forEach(colId => {
            // Conta apenas os cards visíveis (não ocultos pelo filtro)
            const count = Array.from(columns[colId].children).filter(c => !c.classList.contains('hidden')).length;
            columnCounts[colId].textContent = count;
        });
    }

    // Aplica filtro por prioridade (mostra apenas cards com a prioridade selecionada)
    function applyPriorityFilter(){
        const val = headerPrioritySelect ? headerPrioritySelect.value : null;
        if (!val) return;
        
        // *** CORREÇÃO LÓGICA DO FILTRO ***
        const cards = document.querySelectorAll('.task-card');
        cards.forEach(card => {
            // Se "Todas" for selecionado, remove 'hidden' de todos
            if (val === 'all') {
                card.classList.remove('hidden');
            } 
            // Se o cartão tiver uma prioridade e ELA FOR DIFERENTE da selecionada, esconde.
            else if (card.dataset.priority && card.dataset.priority !== val) {
                card.classList.add('hidden');
            } 
            // Caso contrário (é "Todas" ou a prioridade bate certo), mostra.
            else {
                card.classList.remove('hidden');
            }
        });
        // Atualiza a contagem DEPOIS de filtrar
        updateAllCounts();
    }

    // --- 6. RENDERIZAÇÃO E MODAIS (Funções Auxiliares) ---
    
    function showModal(modal, content){ 
        modal.classList.remove('hidden'); 
        setTimeout(()=>{ 
            modal.classList.add('opacity-100'); 
            content.classList.add('scale-100','opacity-100'); 
            content.classList.remove('scale-95','opacity-0'); 
        }, 10);
    }

    function hideModal(modal, content){ 
        content.classList.remove('scale-100','opacity-100'); 
        content.classList.add('scale-95','opacity-0'); 
        modal.classList.remove('opacity-100'); 
        setTimeout(()=> modal.classList.add('hidden'), 200); 
    }

    // Abertura do Modal de Tarefa
    async function openTaskModal(mode = 'add', taskId = null){
        modalErrorMessage.textContent = '';
        taskForm.reset();
        
        // --- MODIFICADO: Define prioridade 'medium' por defeito, não a do filtro ---
        taskPriorityInput.value = 'medium'; 
        // O filtro (headerPrioritySelect) é só para filtrar, não para definir
        
        saveTaskBtn.disabled = false;
        saveTaskBtn.textContent = "Salvar";

        if (mode === 'add') {
            modalTitle.textContent = 'Adicionar';
            taskIdHidden.value = '';
            taskIdInput.value = `OS-${Math.floor(10000 + Math.random() * 90000)}`;
            taskIdInput.classList.remove('hidden');
            taskIdInput.disabled = false;
            taskIdDisplay.classList.add('hidden');
        } else if (mode === 'edit' && taskId) {
            // --- MODIFICADO: Só Admin pode editar ---
            if (userRole !== 'admin') {
                // Removemos o 'alert' para uma experiência mais suave
                console.warn("Utilizador tentou editar, mas não é admin.");
                return; // Simplesmente não abre o modal de edição
            }

            // No modo de edição, buscamos os dados direto do Realtime DB
            try {
                // --- MODIFICADO: Usa writeTasksRef para garantir que pode ler a tarefa (caso seja admin vendo tarefa de user) ---
                const snap = await writeTasksRef.child(taskId).once('value'); 
                if (!snap.exists()) {
                    alert("Erro: Tarefa não encontrada.");
                    return;
                }
                const task = snap.val();

                modalTitle.textContent = 'Editar';
                taskIdHidden.value = taskId; // O ID para salvar
                taskIdInput.classList.add('hidden');
                taskIdInput.disabled = true;
                taskIdDisplay.textContent = `ID: ${task.idOS || task.id}`; // O ID visível
                taskIdDisplay.classList.remove('hidden');
                taskTextInput.value = task.text;
                taskPriorityInput.value = task.priority || 'medium';

            } catch(err) {
                alert("Erro ao carregar tarefa: " + err.message);
                return;
            }
        }
        
        showModal(taskModal, taskModalContent);
        setTimeout(()=> taskTextInput.focus(), 150);
    }

    function closeTaskModal(){ 
        hideModal(taskModal, taskModalContent); 
    }

    function showDeleteModal(id){ 
        taskToDeleteId = id; 
        confirmDeleteBtn.disabled = false;
        showModal(deleteModal, deleteModalContent); 
    }

    function hideDeleteModal(){ 
        hideModal(deleteModal, deleteModalContent); 
        taskToDeleteId = null; 
    }

    // Gerador de Classes de Prioridade
    function getPriorityClasses(priority){
        if (priority === 'high') return { border:'border-red-500', text:'Alta', bg:'bg-red-500' };
        if (priority === 'medium') return { border:'border-orange-500', text:'Média', bg:'bg-orange-500' };
        if (priority === 'low') return { border:'border-blue-500', text:'Baixa', bg:'bg-blue-500' };
        // default / all
        return { border:'border-gray-400', text:'Todas', bg:'bg-gray-500' };
    }

    // Atualiza o badge de prioridade ao lado do título
    const titlePriorityBadge = document.getElementById('title-priority-badge');
    function updatePriorityBadges(){
        if (!headerPrioritySelect) return;
        const val = headerPrioritySelect.value;
        const p = getPriorityClasses(val);
        if (titlePriorityBadge) {
            titlePriorityBadge.textContent = p.text;
            titlePriorityBadge.className = `text-xs font-semibold px-2 py-1 rounded-full ${p.bg} text-white`;
        }
    }
    headerPrioritySelect.addEventListener('change', () => { 
        // *** CORREÇÃO: Atualiza o badge PRIMEIRO, depois aplica o filtro ***
        updatePriorityBadges(); 
        applyPriorityFilter(); 
    });
    // Inicializa o badge com o valor atual e aplica filtro padrão
    updatePriorityBadges();
    applyPriorityFilter();

    // Criação do Elemento Card
    function createTaskElement(task, taskId){
        const p = getPriorityClasses(task.priority);
        // Sanitização é boa prática
        const idSan = DOMPurify.sanitize(task.idOS || task.id || '');
        const textSan = DOMPurify.sanitize(task.text);
        const emailSan = DOMPurify.sanitize(task.owner_email || 'N/A'); // <-- ADICIONADO: Email do dono
        
        const card = document.createElement('div');
        // --- MODIFICADO: Cursor só é 'move' se for admin ---
        card.className = `task-card bg-white p-4 rounded-lg shadow-md border-l-4 ${p.border} group relative ${userRole === 'admin' ? 'cursor-move' : 'cursor-default'}`;
        // dataset.taskId deve ser a chave do nó no Realtime DB
        card.dataset.taskId = taskId || task.id;
        // Armazena a prioridade também para facilitar o filtro
        card.dataset.priority = task.priority || 'medium';
        
        card.innerHTML = `
            <p class="text-sm font-semibold text-gray-500">${idSan}</p>
            <p class="text-gray-800 mt-1.5 font-medium task-text">${textSan}</p>
            <p class="text-xs text-gray-400 mt-2 pt-2 border-t border-gray-100">Solicitado por: ${emailSan}</p> <!-- <-- ADICIONADO -->
            <div class="flex justify-between items-center mt-3">
                <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${p.bg} text-white">${p.text}</span>
            </div>
            <!-- MODIFICADO: Botão de apagar só aparece para admin -->
            <button class="delete-task-btn ${userRole === 'admin' ? '' : 'hidden'} absolute top-2 right-2 text-gray-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity" aria-label="Encerrar OS">✕</button>
        `;
        
        // --- MODIFICADO: Evento de clique SÓ para admin ---
        if (userRole === 'admin') {
            card.addEventListener('click', () => openTaskModal('edit', card.dataset.taskId));
        }
        
        // O evento do botão de excluir (já tem a classe 'hidden' se não for admin)
        card.querySelector('.delete-task-btn').addEventListener('click', (e)=>{ 
            e.stopPropagation(); // Impede que o clique abra o modal de edição
            showDeleteModal(card.dataset.taskId); 
        });
        
        return card;
    }

    // --- 7. EVENT LISTENERS PRINCIPAIS (Modais e Botões) ---

    // Evento de Envio do Formulário (MODIFICADO PARA FIREBASE)
    taskForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        modalErrorMessage.textContent = '';
        saveTaskBtn.disabled = true;
        saveTaskBtn.textContent = "Salvando...";

        const text = taskTextInput.value.trim();
        const priority = taskPriorityInput.value;
        const editingId = taskIdHidden.value; // ID do doc (se estiver editando)

        if (!text) { 
            modalErrorMessage.textContent = 'A descrição é obrigatória.'; 
            saveTaskBtn.disabled = false;
            saveTaskBtn.textContent = "Salvar";
            return; 
        }

        try {
            if (editingId) {
                // --- MODO EDIÇÃO (UPDATE) ---
                // (Já verificámos no openTaskModal que só admin pode editar)
                await writeTasksRef.child(editingId).update({ // <-- MODIFICADO para writeTasksRef
                    text: text,
                    priority: priority
                    // Adms podem editar mais campos aqui se necessário
                });
            } else {
                // --- MODO ADIÇÃO (PUSH) ---
                // Normaliza o ID da OS para evitar duplicatas por diferença de case/espacos
                const idOS = taskIdInput.value.trim().toUpperCase(); // ID da OS (customizado)
                if (!idOS) { 
                    modalErrorMessage.textContent = 'Nº / Código é obrigatório.'; 
                    saveTaskBtn.disabled = false;
                    saveTaskBtn.textContent = "Salvar";
                    return; 
                }

                const newTask = {
                    idOS: idOS,
                    text: text,
                    priority: priority,
                    column: 'col-restaurar', // Sempre começa na primeira coluna
                    createdBy: userUid, // <-- ADICIONADO
                    owner_email: currentUser.email // <-- ADICIONADO
                };

                // Verifica se já existe uma tarefa com o mesmo idOS
                // (Verificação agora usa a referência de LEITURA correta, seja admin ou user)
                const existsSnap = await dbTasksRef.orderByChild('idOS').equalTo(idOS).once('value');
                if (existsSnap.exists()) {
                    modalErrorMessage.textContent = 'Este número já existe.';
                    saveTaskBtn.disabled = false;
                    saveTaskBtn.textContent = "Salvar";
                    return;
                }

                // Usa push() para gerar uma chave única e salvar idOS dentro do objeto
                const newRef = writeTasksRef.push(); // <-- MODIFICADO para writeTasksRef
                await newRef.set(newTask);
            }
            
            closeTaskModal();
            // Não precisa renderizar, os listeners do Realtime DB fazem isso!

        } catch (err) {
             modalErrorMessage.textContent = 'Erro ao salvar: ' + err.message;
             saveTaskBtn.disabled = false;
             saveTaskBtn.textContent = "Salvar";
        }
    });

    // Evento de Exclusão (MODIFICADO PARA FIREBASE)
    confirmDeleteBtn.addEventListener('click', async () => {
        if (taskToDeleteId) {
            // --- MODIFICADO: Verificação de Admin ---
            if (userRole !== 'admin') {
                alert("Apenas administradores podem excluir tarefas.");
                return;
            }

            confirmDeleteBtn.disabled = true;
            try {
                await writeTasksRef.child(taskToDeleteId).remove(); // <-- MODIFICADO para writeTasksRef
                hideDeleteModal();
                // Não precisa renderizar, os eventos child_removed cuidarão disso
            } catch (err) {
                alert("Erro ao excluir: " + err.message);
                confirmDeleteBtn.disabled = false;
            }
        }
    });

    // Listeners de fechar modais
    cancelDeleteBtn.addEventListener('click', hideDeleteModal);
    closeModalBtn.addEventListener('click', closeTaskModal);
    cancelModalBtn.addEventListener('click', closeTaskModal);
    taskModal.addEventListener('click', (e) => { if (e.target === taskModal) closeTaskModal(); });
    deleteModal.addEventListener('click', (e) => { if (e.target === deleteModal) hideDeleteModal(); });
    addTaskBtn.addEventListener('click', () => openTaskModal('add'));

    // --- 8. INICIALIZAÇÃO DO DRAG & DROP (Sortable.js) ---

    function initSortable(role){ // <-- MODIFICADO: Recebe a função (role)
        columnIds.forEach(colId => {
            const el = columns[colId]; // <-- Adicionada esta linha que faltava
            if (!el) return; // <-- Adicionada esta verificação
            
            new Sortable(el, { // <-- Modificado de columns[colId] para el
                group: 'kanban',
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                disabled: (role !== 'admin'), // <-- MODIFICADO: Desabilita se não for admin
                
                // Evento ao soltar o card (MODIFICADO PARA FIREBASE)
                onEnd: (evt) => {
                    // --- MODIFICADO: Verificação de Admin ---
                    if (userRole !== 'admin') return; 

                    const taskId = evt.item.dataset.taskId;
                    const newCol = evt.to.dataset.columnId;
                    const oldCol = evt.from.dataset.columnId;

                    if (newCol === oldCol) return; // Não faz nada se for a mesma coluna
                    
                    // Atualiza apenas a coluna no banco de dados
                    writeTasksRef.child(taskId).update({ column: newCol }) // <-- MODIFICADO para writeTasksRef
                    .catch(err => {
                        alert("Erro ao mover card. Revertendo.");
                        // Reverte o movimento visualmente (opcional, mas bom)
                        evt.from.appendChild(evt.item);
                    });
                    
                    // Atualiza contadores locais imediatamente
                    updateAllCounts();
                }
            });
        });
    }

    // --- 9. EXECUÇÃO INICIAL ---
    // A inicialização agora é controlada pelo onAuthStateChanged (seção 4)
});
</script>
</body>
</html>
